<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html><head>





<meta http-equiv="Content-Language" content="cs">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-2"><title>Mod_rewrite - pøíklady</title>


<style type="text/css">
pre {overflow:auto;padding:1em 0px; margin-top:.5em;background-color:#F4F4FF;color:black}
pre .barva01 {color:red;}
pre .barva02 {color:#2634CF;}
pre .barva03 {color:#EF1DC3;}
pre .barva04 {color:#67A0CF;}
pre .barva05 {color:#CF5919;}
pre .barva06 {color:#A367CF;}
pre .rwkoment {color:gray;}
</style>



<link rel="stylesheet" href="mod-rewrite-priklady_soubory/jpw.css"></head><body class="ost" id="www-jakpsatweb-cz">
<div id="text">
	

<h1>Mod_rewrite - pøíklady</h1>
<p class="podtitul">Petr Neuman</p>

<p>Toto není popis tohoto módu. Tìchto pár pøíkladù je pouze doplòkem
<a href="http://www.jakpsatweb.cz/server/mod-rewrite.html">k úvodnímu návodu</a> a snad poslou¾í jako zdroj inspirace 
èi k pochopení nìkterých vztahù.
</p>

<ul>
<li><a href="#dyntostat">Zmìna dynamických adres na statické</a></li>
<li><a href="#zakaz">Zakázání nìkterých souborù</a></li>
<li><a href="#zakaz_parametru_robotum">Zakázání parametrù nìkterým robotùm</a></li>
<li><a href="#oprava_ampersandu">Pøevádìní <tt>&amp;amp;</tt> na <tt>&amp;</tt> v query 
stringu</a></li>
<li><a href="#oprava_adresy">Opravení ¹patnì vyparsované adresy</a></li>
<li><a href="#rozlozeni_zateze">Rozlo¾ení zátì¾e na více poèítaèù</a></li>
<li><a href="#ukladani_souboru">Ukládací dialog pro známé soubory</a></li>
<li><a href="#robots_txt">Rùzné <tt>robots.txt</tt> podle domény</a></li>
<li><a href="#minibb-base">Zapnutí rewrite u minibb 2.0</a></li>
<li><a href="#minibb-advanced">Zapnutí rewrite u minibb 2.0 s rewritemapou</a></li>
</ul>


<h3 id="dyntostat">Zmìna dynamických adres na statické</h3>
<p>Následující pou¾ití ukazuje jednoduchý pøíklad pøechodu na pøepisované 
adresy. Pùvodní adresy byly typu <tt>/index.php?page=neco</tt> - rádi bychom <tt>
/neco.html</tt> skrytì pøepsané na fungující skript. Pro zachování odkazù z 
jiných webù a vyhledávaèù (ale se snahou o propagaci nové podoby adres) 
vytvoøíme pøesmìrování na nové adresy.
</p>
<pre>RewriteEngine On
<span class="rwkoment">#RewriteBase /adresar</span>
RewriteCond %{QUERY_STRING} ^page=<span class="barva01">(</span>[^&amp;]+<span class="barva01">)</span>$
RewriteRule ^index\.php$ <span class="barva01">%1</span>.html? [R=301,L]
RewriteRule ^<span class="barva02">(</span>[^/]+<span class="barva02">)</span>\.html index.php?rw=1&amp;page=<span class="barva02">$1</span> [L,QSA]</pre>
<p>
Proto¾e v <tt>RewriteRule</tt> nelze testovat parametry za otazníkem (query 
string), musíme pou¾ít pomínku <tt>RewriteCond</tt> s testováním této promìnné. 
Pokud má po¾adovaný tvar, bude kontrolovat následující pravidlo. V nìm vytáhneme 
ozávorkovanou èást z poslední pou¾ité podmínky díky <tt>%1</tt>. Za koncovku <tt>
.html</tt> pøidáme je¹tì onen otazník, aby se automaticky nepøidal query string. 
Dal¹í pravidlo je u¾ klasické - skrytý pøepis statické adresy na dynamickou. 
Pøidáme v¹ak nìjaký parametr (v na¹em pøípadì <tt>rw=1</tt>), aby se pøepisování 
necyklilo.
</p>
<p>
Pokud to máme v nìjakém adresáøi, odkomentujte druhý øádek s <tt>RewriteBase</tt> 
a napi¹te tam správnou cestu toho adresáøe. Pro koøenový adresáø tedy pou¾ijte <tt>
/</tt>.
</p>


<h3 id="zakaz">Zakázání nìkterých souborù</h3>
<p>Pokud máme na webu soubory, které tam vy¾adujeme, ale nechceme, aby si je 
mohl nìkdo prohlí¾et, mù¾eme vyu¾ít síly Rewrite módu. Napøíklad schovat v¹echny 
soubory v adresáøích CVS tím, ¾e server vrátí kód 403 - zakázané.
</p>
	<pre>RewriteEngine On
RewriteRule ^(.*/)?CVS/.* - [F]</pre>
<p>
Onen pøíznak F znamená Forbidden. Pomlèka je speciální znak pro zachování poètu 
parametrù jedlotlivých pøíkazù bez hlub¹ího smyslu (u <tt>RewriteRule</tt> tedy 
znamená nìco jako "nech být, jak to je").
</p>

<h3 id="zakaz_parametru_robotum">Zakázání parametrù nìkterým robotùm</h3>
<p>Na zakázání pøístupu robotù do urèitých èástí stránek mù¾eme vcelku s 
úspìchem pou¾ít <tt>robots.txt</tt>. Pokud ale chceme zakázat tøeba jen nìkteré 
parametry pro na¹e skripty, s <tt>robots.txt</tt> toho nedosáhneme. Mù¾eme tedy 
testovat, zda jde o roboty, kteøí nám pøi takových parametrech dìlají neplechu a 
napøíklad indexují i stránky, kde je v meta elementu <tt>robots</tt> nastavena 
hodnota <tt>noindex</tt>. Následují pøíklad znepøístupní vyjmenovaným tøem 
robotùm jakoukoliv stránku s nastaveným parametrem od (který máme napø. pou¾itý 
pro listování).
</p>
<pre>RewriteEngine on
RewriteCond %{QUERY_STRING} ^(.*&amp;)?od=.*$
RewriteCond %{HTTP_USER_AGENT} ^Jyxobot.*$ [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^findlinks.*$ [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^cfetch.*$ [NC]
RewriteRule ^.*$ - [F]</pre>
<p>
První podmínka RewriteCond testuje, zda je v query stringu parametr <tt>od</tt>. 
Pokud je, testuje se dal¹í podmínka na podobu promìnné <tt>HTTP_USER_AGENT</tt>, 
zde je v¹ak dùle¾itý pøíznak OR, který je logickou spojkou nebo. Ony ètyøi øádky 
s RewriteCond tedy znamenají nìco jako "pokud je tam parametr <tt>od</tt> a 
zároveò agent zaèíná na <tt>Jyxobot</tt> nebo <tt>findlinks</tt> nebo <tt>cfetch</tt>". 
Pokud tato slo¾ená podmínka platí, po¹le server na jakýkoliv po¾adavek kód 403 - 
zakázáno (díky ji¾ známému pøíznaku <tt>F</tt>). Pøíznak <tt>NC</tt> v <tt>
RewriteCond</tt> vypíná rozli¹ování velikosti písmen.
</p>

<h3 id="oprava_ampersandu">Pøevádìní <tt>&amp;amp;</tt> na <tt>&amp;</tt> v query 
stringu</h3>
<p>Nìkteøí hloupí vyhledávací roboti (kdysi napø. SeznamBot) nepøevádí html 
entity v nalezených adresách tak, jak mají. Pokud tedy validnì odìlujete 
jednotlivé parametry pomocí znaku <tt>&amp;</tt> (který se v html pí¹e jako <tt>&amp;amp;</tt>) 
mù¾ete pou¾ít následující pøepisovací pravidla na odchytání takto chybných 
po¾adavkù pro celý web na jednom místì.
</p>
<pre>RewriteEngine on
<span class="rwkoment">#RewriteBase  /adresar</span>
RewriteCond %{QUERY_STRING} ^<span class="barva01">(</span>.*<span class="barva01">)</span>&amp;amp;<span class="barva03">(</span>.*<span class="barva03">)</span>$
RewriteRule ^<span class="barva02">(</span>.*<span class="barva02">)</span>$ <span class="barva02">$1</span>?<span class="barva01">%1</span>&amp;<span class="barva03">%2</span> [E=newqs:<span class="barva01">%1</span>&amp;<span class="barva03">%2</span>,N]
RewriteCond %{ENV:newqs} !^$
RewriteRule ^<span class="barva04">(</span>.*<span class="barva04">)</span>$ <span class="barva04">$1</span>?%{ENV:newqs} [R=301,L]</pre>
<p>
První podmínkou zkontrolujeme, zda se v query stringu vyskytuje <tt>&amp;amp;</tt>. 
Pokud se tam najde, nahradí se správným <tt>&amp;</tt>. Pøitom se udìlá i to, ¾e se 
nový query string ulo¾í do promìnné <tt>newqs</tt>
díky pøíznaku <tt>E</tt>. Dal¹í pøíznak <tt>N</tt> - next round - vyvolá 
projí¾dìní pøepisovacích pravidel znovu od zaèátku (pokud se ono <tt>RewriteRule</tt> 
provádìlo). Toto se bude provádìt do té doby, dokud tam u¾ ¾ádný výskyt <tt>
&amp;amp;</tt> nebude. Pak pøijde na øadu dal¹í pomínka <tt>RewriteCond</tt>, která 
kontroluje, zda je promìnná <tt>newqs</tt> neprázná. Pokud není prázná (tzn. byl 
tam kdysi <tt>&amp;amp;</tt>), provede se viditelné pøesmìrovací pravidlo s pou¾itím 
opraveného query stringu ulo¾eného do promìnné.
</p>
<p>
Na pøíznak <tt>N</tt> dávejte veliký pozor! Nikdy ho netestujte na ostrých 
serverech, ale jen u sebe doma a i tak hodnì opatrnì (ale dùkladnì). Nesmí se 
vám to zacyklit. Na tento pøíznak se toti¾ nevztahuje limit na poèet tajných 
pøepsání (výchozí <tt>RewriteOptions MaxRedirects=10</tt>), tak¾e mù¾ete zahltit 
apache a nejspí¹e se z toho dostane jen jeho restartem.
</p>

<h3 id="oprava_adresy">Opravení ¹patnì vyparsované adresy</h3>
<p>Kdy¾ se uvádí URI v bì¾ném textu, èasto se za nimi vyskytují interpunkèní 
znaménka, závorky a uvozovky, které hor¹í parsery mohou brát jako souèást 
adresy. Otestujeme, zda je po¾adovaná stránka dostupná a pokud není, zkusíme 
pøípadné divné znaky z konce odstranit.
</p>
<pre>RewriteEngine On
<span class="rwkoment">#RewriteBase  /adresar</span>
RewriteCond %{QUERY_STRING} ^<span class="barva01">(</span>.*[^\.\?\),!-"']<span class="barva01">)</span>[\.\?\),!-"']+$
RewriteRule ^<span class="barva02">(</span>.*<span class="barva02">)</span>$ <span class="barva02">$1</span>?<span class="barva01">%1</span> [R=301,L]
RewriteCond %{REQUEST_FILENAME} !-F
RewriteRule ^<span class="barva04">(</span>.*[^\.\?\),!-"']<span class="barva04">)</span>([\.\?\),!-"'])+$ <span class="barva04">$1</span> [R=301,L]</pre>
<p>
Kotrolujeme tedy nejdøíve znaky <tt>. ? ) , ! - " '</tt> na konci query stringu 
(asi víme, ¾e je na webu nepou¾íváme a mù¾eme je odstranit). Pokud na konci tyto 
podivné znaky jsou, viditelnì pøesmìrujeme na verzi, kde budou oddìlány. Dal¹í <tt>
RewriteCond</tt> kontroluje pomocí <tt>-F</tt>, zda apache nìjak najde základní 
po¾adavek bez query stringu. Pokud tomu tak není, bude se provádìt následující <tt>
RewriteRule</tt>, které v pøípadì, ¾e jsou na konci opìt zmínìné znaky, 
viditelnì pøesmìruje na verzi, v ní¾ budou z konce odstranìny.
</p>
<p>Budeme-li mít tedy v na¹em adresáøi soubory <tt>test</tt> a <tt>test.</tt> 
ale nic jiného, dostaneme pøi po¾adavku na <tt>test.</tt> správnì <tt>test.</tt>, 
ale pøi po¾adavku na <tt>test..</tt>
se v¹echna interpukce na konci odstraní a pøesmìruje nás to na <tt>test</tt> bez 
teèky. Pøi ¾ádosti o <tt>test..?querystring.</tt> se postupnì provedou dvì 
pøesmìrování na jejich¾ konci bude <tt>test?querystring</tt> - nejdøíve se 
odtranila teèka z query stringu a pak i dvì teèky ze jména souboru.
</p>

<h3 id="rozlozeni_zateze">Rozlo¾ení zátì¾e na více poèítaèù</h3>
<p>Za jistých okolností lze pomocí Rewrite módu tajnì pøepisovat i na jiné 
servery. Je v¹ak nutné k tomu mít v apachi zapnutý mod_proxy. Mù¾e se to hodit 
napøíklad k rozhození výpoèetní zátì¾e na více na¹ich strojù. Pro výbìr stroje 
pou¾ijeme pøepisovací mapu typu <tt>rnd</tt> (náhodnou) a to jen na soubory s 
koncovkami
<tt>php</tt>, <tt>pl</tt>, <tt>py</tt> a <tt>ru</tt>, kde pøedpokládáme vy¹¹í 
nároky na procesor.
</p>
<pre><span class="rwkoment">#prepisovaci mapa musi byt v definovana v konfiguraci apache, v .htaccess to nelze</span>
<span class="rwkoment">#RewriteMap servery rnd:/cesta/k/mapa.txt</span>
RewriteEngine on
RewriteRule ^<span class="barva02">(</span>.*\.(php|pl|py|ru)<span class="barva02">)</span> http://${servery:nahodny}/<span class="barva02">$1</span> [P,L]</pre>
<p>
Definovat pøepisovací mapu pomocí pøíkazu <tt>RewriteMap</tt> lze pouze v 
konfiguraci serveru nebo v nastavení virtual hostu. My pou¾ijeme typ <tt>rnd</tt>, 
který vybere náhodnì jednu hodnotu ze seznamu ke konkrétnímu klíèi. Ke shlédnutí 
je ukázka pou¾ité <a href="http://www.jakpsatweb.cz/server/mod_rewrite/mapa.txt">pøepisovací mapy</a>. Syntaxe pou¾ití mapy 
je jednoduchá, pou¾ijeme název mapy a hodnotu, kterou hledáme (lze pøípadnì i 
definovat hodnotu, která se má pou¾ít, pokud nebyl klíè v mapì nalezen). Pøíznak <tt>
P</tt>
øíká, ¾e chceme pou¾ít proxy modul a tím zpùsobem tajnì pøesmìrovat na jiný 
server. Tento pøíklad nebyl zkou¹en pro nedostateèné technické zázemí, ale je 
uvádìn pro demonstraci málo známé mo¾nosti Rewrite módu.
</p>

<h3 id="ukladani_souboru">Ukládací dialog pro známé soubory</h3>
<p>Obèas se mù¾e hodit vyvolat stahovací dialog v prohlí¾eèi i pro soubory, 
které umí normálnì zobrazit. Mù¾eme pomocí <tt>RewriteRule</tt> zmìnit mime-type 
souboru tøeba na <tt>application/octet-stream</tt> a tak docílíme toho, ¾e 
pøebijeme základní nastavení apache. Pokud budeme chtít soubor takto stáhnout, 
pøidáme za nìj parametr <tt>stahnout</tt>.
</p>
<pre>RewriteEngine on
<span class="rwkoment">#RewriteBase  /adresar</span>
RewriteCond %{QUERY_STRING} ^stahnout$
RewriteRule \.(jpe?g|gif|png)$ - [L,NC,T=application/octet-stream]</pre>
<p>
Pokud na server pøijde po¾adavek na soubor s koncovku <tt>jpg</tt>, <tt>jpeg</tt>, <tt>
gif</tt> nebo <tt>png</tt>
a je pøidán parametr <tt>stahnout</tt> (napøíklad <tt>obrazek.jpg?stahnout</tt>), 
zapøíèiní uvedená pravidla zmìnu mime-typu a tím vyvolají dialog pro stáhnutí. 
Zmìnu typu vyvolá parametr <tt>T</tt>. Parametr <tt>NC</tt> vypíná rozli¹ování 
velikosti písmen v <tt>RewriteRule</tt>. Koncovky, kterým chceme povolit 
stahování je dobré vyjmenovat, aby nám díky tomuto parametru nìkdo nestahoval 
tøeba zdrojáky v php (pokud toti¾ takto zmìníme typ souboru, bude s ním apache 
podle toho zacházet a nebude brát php soubor jako skript).
</p>


<h3 id="robots_txt">Rùzné <tt>robots.txt</tt> podle domény</h3>
<p>Pokud chceme mít více domén se stejným obsahem generovaným z jednoho 
adresáøe, mù¾e nám vadit, ¾e vyhledávací systémy poznají, ¾e se jedná o 
duplicity a nìkteré vìci ukazují z jiných adres, ne¾ bychom chtìli. Nachystáme 
si tedy nìkolik rùzných souborù <tt>robots.txt</tt>, kterými zaká¾eme pro danou 
doménu pøesnì ty adresáøe a soubory, které chceme (pokud mo¾no v¾dy povolíme 
urèité podstránky jen na jednom serveru).
</p>
<pre>RewriteEngine on
<span class="rwkoment">#RewriteBase  /adresar</span>
RewriteRule !^robots\.txt$ - [L]
RewriteCond _%{HTTP_HOST}_robots.txt -F
RewriteRule ^robots\.txt$ _%{HTTP_HOST}_robots.txt [L]</pre>
<p>
Ná¹ systém poèítá s tím, ¾e budou pøipraveny soubory vzoru <tt>
_example.com_robots.txt</tt> 
nebo <tt>_127.0.0.1_robots.txt</tt>. Pokud bude odpovídat host v po¾adavku 
nìkteré z nachystaných variant, podstrèí se jako <tt>robots.txt</tt> právì ona. 
První <tt>RewriteRule</tt> máme jen pro co nejni¾¹í zátì¾ serveru - pokud není 
po¾adavek <tt>robots.txt</tt>, nic nepøepisuj.
<tt>RewriteCond</tt> pøípadnì zkontroluje, zda má apache k dispozici pøíslu¹nou 
variantu na¹eho vzoru, pokud ano, tak ji dal¹í pøíkaz tajnì podstrèí.
</p>


<h3 id="minibb-base">Zapnutí rewrite u minibb 2.0</h3>
<p>Následující pøíklad je jen tro¹ku slo¾itìj¹í nì¾ ten první. Pokud pou¾íváte 
<a href="http://www.minibb.net/">minibb</a> fórum, mù¾e se vám hodit - poèínaje verzí 2.0 umí toto fórum pou¾ít 
odkazy, které vypadají jako html soubory. Pokud na nìj pøecházíme z ni¾¹í verze, 
nebo jsme jen zapomnìli odkomentovat <tt>$mod_rewrite=TRUE;</tt> a chceme co 
nejvíce pou¾ívat nové adresy, pou¾ijeme takto upravená pravidla, která zaruèí 
zpìtnou kompatibilitu.
</p>
<pre class="sirsi">RewriteEngine On
<span class="rwkoment">#RewriteBase /adresar</span>

<span class="rwkoment">#parametry na kratkou html adresu</span>
RewriteCond %{QUERY_STRING} ^action=userinfo&amp;user=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>$
RewriteRule ^index\.php$ user<span class="barva01">%1</span>.html? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vtopic&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>$
RewriteRule ^index\.php$ <span class="barva01">%1</span>_0.html? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vtopic&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>&amp;page=<span class="barva03">(</span>[0-9]+<span class="barva03">)</span>$
RewriteRule ^index\.php$ <span class="barva01">%1</span>_<span class="barva03">%2</span>.html? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vthread&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>&amp;topic=<span class="barva03">(</span>[0-9]+<span class="barva03">)</span>$
RewriteRule ^index\.php$ <span class="barva01">%1</span>_<span class="barva03">%2</span>_0.html? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vthread&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>&amp;topic=<span class="barva03">(</span>[0-9]+<span class="barva03">)</span>&amp;page=<span class="barva05">(</span>[0-9]+<span class="barva05">)</span>$
RewriteRule ^index\.php$ <span class="barva01">%1</span>_<span class="barva03">%2</span>_<span class="barva05">%3</span>.html? [R=301,L]

<span class="rwkoment">#html adresy tajne na puvodni (pridano rw=1, aby se to necyklilo)</span>
RewriteRule ^user<span class="barva02">(</span>[0-9]+<span class="barva02">)</span>\.html$ index.php?action=userinfo&amp;user=<span class="barva02">$1</span>&amp;rw=1  [L]
RewriteRule ^<span class="barva02">(</span>[0-9]+<span class="barva02">)</span>_<span class="barva04">(</span>[0-9]+<span class="barva04">)</span>\.html$ index.php?action=vtopic&amp;forum=<span class="barva02">$1</span>&amp;page=<span class="barva04">$2</span>&amp;rw=1  [L]
RewriteRule ^<span class="barva02">(</span>[0-9]+<span class="barva02">)</span>_<span class="barva04">(</span>[0-9]+<span class="barva04">)</span>_<span class="barva06">(</span>[0-9]+<span class="barva06">)</span>\.html$ index.php?action=vthread&amp;forum=<span class="barva02">$1</span>&amp;topic=<span class="barva04">$2</span>&amp;page=<span class="barva06">$3</span>&amp;rw=1  [L]</pre>
<p>Pracuje to na stejném principu jako pøíklad na zaèátku, jen tam je prostì víc 
vztahù. V tomto pøíkladì není nutný pomocný parametr <tt>rw=1</tt>, staèilo by 
pøeházet poøadí parametrù.
</p>

<h3 id="minibb-advanced">Zapnutí rewrite u minibb 2.0 s rewritemapou</h3>
<p>Pokud umíme trochu php, tak si lze adresy v minibb upravit k obrazu svému. 
Místo èísel pro fórum pou¾ijeme nìjaký výsti¾ný popis. Pøevod mezi èísly a texty 
zvládneme pomocí <tt>RewriteMap</tt>. Vhledem k tomu, ¾e u¾ to bude slo¾itìj¹í 
pou¾ití pøepisovacíh pravidel, zkusíme procházení optimalizovat a co nejménì 
zatì¾ovat server pøepisováním.
</p><p>Cílem na¹eho pøepisování budou tedy adresy typu<br>
<tt>example.com/nas_nazev_fora</tt><br>
<tt>example.com/nas_nazev_fora/cislovlakna</tt><br>
pokud zapomeneme definovat vztahy mezi èísly a texty, tak typu<br>
<tt>example.com/forum-cislo</tt><br>
<tt>example.com/forum-cislo/cislovlakna</tt><br>
a za to mù¾e být je¹tì pøidáno <tt>/stranka-cislo</tt> pro pøípadné stránkování.
</p>
<pre class="sirsi">RewriteEngine On
<span class="rwkoment">#RewriteBase /adresar</span>

<span class="rwkoment">#primo v konfiguraci apache (napr. pro nas virtualni server) musime uvest prepisovaci mapy</span>
<span class="rwkoment">#RewriteMap nototext txt:/cesta/k/mapa01.map</span>
<span class="rwkoment">#RewriteMap texttono txt:/cesta/k/mapa02.map</span>

<span class="rwkoment">#urychleni prochazeni pravidel - vyskoceni co nejdriv to jde</span>
<span class="rwkoment">#pokud je k dispocici primo soubor bez prepisovani a neni to index.php, tak neprepisuj nic</span>
RewriteCond %{REQUEST_FILENAME} !index\.php
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule .* - [L]
<span class="rwkoment">#pokud je na zacatku nastaveny nas parametr rw, tak pro index.php take vyskoc</span>
RewriteCond %{QUERY_STRING} ^rw=1
RewriteRule ^index\.php$ - [L]
<span class="rwkoment">#pokud je to index.php, tak preskoc 7 nasledujich pravidel RewriteRule</span>
RewriteRule ^index\.php$ - [S=7]
<span class="rwkoment">#konec urychlovani</span>

<span class="rwkoment">#jinak pokracujeme</span>

<span class="rwkoment">#pokud uz mame k foru s cislem popisek v rewrite mape, tak presmerovani</span>
RewriteCond %{REQUEST_FILENAME} .*forum-<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>(/.*)?
RewriteCond ${nototext:<span class="barva01">%1</span>|notfound} !=notfound
RewriteRule ^forum-<span class="barva02">(</span>[0-9]+<span class="barva02">)</span><span class="barva04">(</span>/.*<span class="barva04">)</span>?$ ${nototext:<span class="barva02">$1</span>}<span class="barva04">$2</span> [R=301,L]

<span class="rwkoment">#jestli je na konci stranka-x, hod x do promenne pro pozdejsi pouziti</span>
RewriteRule /stranka-<span class="barva02">(</span>[0-9]+<span class="barva02">)</span>$ - [E=stranka:&amp;page=<span class="barva02">$1</span>]
<span class="rwkoment">#nase adresy tajne na puvodni (pridano rw=1 aby se to necyklilo a umeli jsme rychle vypadnout)</span>
RewriteRule ^forum-<span class="barva02">(</span>[0-9]+<span class="barva02">)</span>(/stranka-[0-9]+)?$ index.php?rw=1&amp;action=vtopic&amp;forum=<span class="barva02">$1</span>%{ENV:stranka} [L,QSA]
RewriteRule ^forum-<span class="barva02">(</span>[0-9]+<span class="barva02">)</span>/<span class="barva04">(</span>[0-9]+<span class="barva04">)</span>(/stranka-[0-9]+)?$ index.php?rw=1&amp;action=vthread&amp;forum=<span class="barva02">$1</span>&amp;topic=<span class="barva04">$2</span>%{ENV:stranka} [L,QSA]
RewriteRule ^<span class="barva02">(</span>[^/\.-]+<span class="barva02">)</span>(/stranka-[0-9]+)?$ index.php?rw=1&amp;action=vtopic&amp;forum=${texttono:<span class="barva02">$1</span>}%{ENV:stranka} [L,QSA]
RewriteRule ^<span class="barva02">(</span>[^/\.-]+<span class="barva02">)</span>/<span class="barva04">(</span>[0-9]+<span class="barva04">)</span>(/stranka-[0-9]+)?$ index.php?rw=1&amp;action=vthread&amp;forum=${texttono:<span class="barva02">$1</span>}&amp;topic=<span class="barva04">$2</span>%{ENV:stranka} [L,QSA]
RewriteRule ^user-<span class="barva02">(</span>[0-9]+<span class="barva02">)</span>\.html$ index.php?rw=1&amp;action=userinfo&amp;user=<span class="barva02">$1</span> [L]

<span class="rwkoment">#kategorie/cislo_threadu</span>
<span class="rwkoment">#parametry na kratkou html adresu - pro zpetnou kompatibilitu</span>
RewriteCond %{QUERY_STRING} ^action=userinfo&amp;user=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>$
RewriteRule ^index\.php$ user-<span class="barva01">%1</span>.html? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vtopic&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>(&amp;sortBy=0)?(&amp;page=0)?$
RewriteRule ^index\.php$ ${nototext:<span class="barva01">%1</span>|forum-<span class="barva01">%1</span>}? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vtopic&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>(&amp;sortBy=0)?&amp;page=<span class="barva05">(</span>[0-9]+<span class="barva05">)</span>$
RewriteRule ^index\.php$ ${nototext:<span class="barva01">%1</span>|forum-<span class="barva01">%1</span>}/stranka-<span class="barva05">%3</span>? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vthread&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>&amp;topic=<span class="barva03">(</span>[0-9]+<span class="barva03">)</span>(&amp;sortBy=0)?(&amp;page=0)?$
RewriteRule ^index\.php$ ${nototext:<span class="barva01">%1</span>|forum-<span class="barva01">%1</span>}/<span class="barva03">%2</span>? [R=301,L]
RewriteCond %{QUERY_STRING} ^action=vthread&amp;forum=<span class="barva01">(</span>[0-9]+<span class="barva01">)</span>&amp;topic=<span class="barva03">(</span>[0-9]+<span class="barva03">)</span>&amp;page=<span class="barva05">(</span>[0-9]+<span class="barva05">)</span>$
RewriteRule ^index\.php$ ${nototext:<span class="barva01">%1</span>|forum-<span class="barva01">%1</span>}/<span class="barva03">%2</span>/stranka-<span class="barva05">%3</span>? [R=301,L]</pre>
<p>
První dvì podmínky <tt>RewriteCond</tt> nám otestují, zda po¾adovaný soubor není <tt>
index.php</tt> a zároveò takový soubor opravdu existuje na serveru. Pokud obì 
podmínky platí, pøestane se pøepisovat díky
<tt>RewriteRule</tt> s nic nemìnící pomlèkou a pøíznakem <tt>L</tt>. Nyní 
testujeme, zda je v query stringu nastavený parametr <tt>rw=1</tt>. Pokud tomu 
tak je a ¾ádaným souborem je <tt>index.php</tt>, také ukonèíme v¹echno 
pøepisování. Posledním testem pro optimalizaci pravidel je opìt test, zda je na 
server po¾adavek o index.php, v kladném pøípadì pøeskoèíme kontrolu náledujích 7 
pravidel <tt>RewriteRule</tt> pomocí pøíznaku <tt>S</tt>.
</p>
<p>
Nyní testujeme, zda není po¾adavek na adresu typu <tt>forum-cislo</tt> a zda 
náhodou u¾ pro toto èíslo nemáme definovaný v pøepisovací mapì textový popis. 
Syntaxe pro vycucnutí hodnoty z mapy je <tt>
${nazev_mapy:hledana_hodnota|hodnota_pokud_se_hledana_nenajde}</tt>. Otestujeme 
tedy, zda výsledná hodnota není ta, kterou pou¾ijeme jako výchozí za znakem <tt>
|</tt>. Pokud tedy u¾ máme pro ono èíslo textový popis definovaný, viditelnì 
pøesmìrujeme na novou adresu.
</p>
<p>Následuje tajné pøepisování na¹ich zvolených adres na pøíslu¹né parametry 
minibb. Nejprve otestujeme, zda je na konci adresy <tt>stranka-cislo</tt>. Pokud 
je, ulo¾íme do promìnné <tt>stranka</tt> øetezec, který se pou¾ívá pro 
stránkování v minibb fóru. Dal¹ích 5 pravidel pøepisuje mo¾né vzory adres na 
správné parametry. Pøidáváme zde pøípadné stránkování ulo¾ené do promìnné <tt>
stranka</tt> a dále pøidáme parametr <tt>rw=1</tt>, který nám umo¾ní rychlej¹í 
opu¹tìní znovuprocházení pøepisovacích pravidel a zamezí tak cyklení.
</p>
<p>
Poslední sada pravidel nám pøesmìruje z kdysi pou¾ívaných adres bì¾ných v tomto 
fóru na nové typy adres. Asi je u¾ jasné, ¾e výsledek <tt>
${nototext:%1|forum-%1}</tt> bude buï textový popis fóra (pokud máme ono èíslo 
definované v pøepisovací mapì nototext) nebo <tt>forum-cislo</tt> (pokud v mapì 
ono èíslo definované není).
</p>
<p>
Jak ji¾ bylo v zmínìno, pøepisovací mapy lze definovat pouze v konfiguraci 
serveru nebo virtual hostu. Je¹tì ukázka tìch pou¾itých pøepisovacíh map - <tt><a href="http://www.jakpsatweb.cz/server/mod_rewrite/mapa01.map">
mapa01.map</a></tt> a <tt><a href="http://www.jakpsatweb.cz/server/mod_rewrite/mapa02.map">mapa02.map</a></tt> 
- jedná se o standardní typ mapy <tt>txt</tt>.
</p>
	<p>
&nbsp;</p>
	<p>
Autorem textu je Petr Neuman</p>

	
	<p>&nbsp;</p>
	

<!--XXXwebbot bot="Include" U-Include="adsense-dole-zluta.html" TAG="BODY" -->


<h3>Reklama</h3>
<p><a href="http://www.webhosting-c4.cz/adv/jw1">
<img src="mod-rewrite-priklady_soubory/c4-01.gif" alt="www.c4.cz, hosting za 1.200 Kè na rok s doménou v cenì" border="0" height="60" width="468"></a></p>
<p>&nbsp;</p>

<p>&nbsp;</p>

</div>

<div id="navigace">
	

<h3>Pøedchozí:</h3>
	<p><a id="prev" href="http://www.jakpsatweb.cz/server/mod-rewrite.html">Mod_rewrite, úvodní návod</a></p>
	<h3>Vizte té¾:</h3>
	<ul>
		<li><a href="http://www.jakpsatweb.cz/server/htaccess.html">Pou¾ití souboru .htaccess</a></li>
		<li><a href="http://www.jakpsatweb.cz/presmerovani.html">Pøesmìrování stránky, rùzné 
		mo¾nosti</a></li>
	</ul>
	<h3>Pou¾ité materiály a doporuèené ètení:</h3>
<p>
<a href="http://httpd.apache.org/docs/2.0/mod/mod_rewrite.html">Popis modulu mod_rewrite</a> 
(anglicky)</p>
	<p>
<a href="http://httpd.apache.org/docs/2.0/misc/rewriteguide.html">Pøíruèka mod_rewrite</a> 
(anglicky)</p>
	
	


<script type="text/javascript"><!--
google_ad_client = "pub-4372514035999321";
google_ad_width = 125;
google_ad_height = 125;
google_ad_format = "125x125_as";
google_ad_type = "text";
//2006-12-16: jpw vpravo, ostatni jpw
google_ad_channel = "2626615486+9426052476";
google_color_border = "FFFFEE";
google_color_bg = "FFFFEE";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "000080";
//--></script>
<script type="text/javascript" src="mod-rewrite-priklady_soubory/show_ads.js">
</script><iframe name="google_ads_frame" src="mod-rewrite-priklady_soubory/ads.htm" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" frameborder="0" height="125" scrolling="no" width="125"></iframe>


</div>



<div id="hlavicka">


	<div id="logo">
		<a href="http://www.jakpsatweb.cz/index.html" id="logoa" accesskey="1">
		<img src="mod-rewrite-priklady_soubory/jakpw.gif" alt="Jak psát web" height="88" width="131"></a>
	</div>

	<div id="slogan">
		o tvorbì, údr¾bì a zlep¹ování internetových stránek
	</div>


<div id="hledani">
	<form action="http://www.google.com/custom">
		<p>
			<input name="cx" value="008997274925841959410:atrkgfnhjvc" type="hidden">	
			<input name="cof" value="LH:;CX:Jak%20ps%C3%A1t%20web;LW:0;FORID:1;S:http://www.jakpsatweb.cz;L:http://www.jakpsatweb.cz/images/jakpw-100.gif;LP:1" type="hidden">
			<input name="hl" value="cs" type="hidden">
			<input name="ie" value="iso-8859-2" type="hidden">
			<input name="client" value="pub-4372514035999321" type="hidden">
			<input name="channel" value="8759767026" type="hidden">
			<input name="q" class="text" size="12" type="text">
			<input name="sa" class="submit" value="Hledat" type="submit">
		</p>
	</form>

</div>
<div id="ouska">
		<a class="zak" href="http://www.jakpsatweb.cz/index.html">Návody</a>
		<a class="html" href="http://www.jakpsatweb.cz/html/index.html">HTML</a>
		<a class="css" href="http://www.jakpsatweb.cz/css/index.html">CSS</a>
		<a class="js" href="http://www.jakpsatweb.cz/javascript/index.html">JavaScript</a>
		<a class="clanky" href="http://www.jakpsatweb.cz/clanky/index.html">Èlánky</a>
		<a class="ost" href="http://www.jakpsatweb.cz/navigace/ostatni.html">Ostatní</a>
	</div>
	
<div id="prouzek">
		
			

<p><a href="http://www.jakpsatweb.cz/enc/encyklopedie.html">Encyklopedie</a>
<a href="http://www.jakpsatweb.cz/frontpage/index.html">FrontPage</a>
<a href="http://www.jakpsatweb.cz/reklama/index.html">Reklama</a> 
<a href="http://www.jakpsatweb.cz/php/index.html">PHP</a>
<a href="http://www.jakpsatweb.cz/server/index.html" id="sel">Server</a>

</p></div>
</div>


<div id="hrasek"><a href="http://www.jakpsatweb.cz/index.html">Jak psát web</a> <b>&gt;</b>  <a href="http://www.jakpsatweb.cz/navigace/ostatni.html">Ostatní</a> <b>&gt;</b>  <a href="http://www.jakpsatweb.cz/server/index.html">Server</a> <b>&gt;</b> Mod_rewrite - pøíklady</div>

<script type="text/javascript" src="mod-rewrite-priklady_soubory/patka.js"></script><div id="prevnexttop" class="panel"> <a href="http://www.jakpsatweb.cz/server/mod-rewrite.html" title="Pøedchozí: Mod_rewrite, úvodní návod">&lt;</a> <a href="http://www.jakpsatweb.cz/server/index.html" title="Obsah podsekce Server">^</a></div><div id="prevnextbottom" class="panel"> <a href="http://www.jakpsatweb.cz/server/mod-rewrite.html" title="Pøedchozí: Mod_rewrite, úvodní návod">&lt;</a> <a href="http://www.jakpsatweb.cz/server/index.html" title="Obsah podsekce Server">^</a></div><div id="wherenext"><a href="#navigace" onclick="navigaciDolu(); return false;">Kam dál?</a></div>

<p class="patka-global"><a href="http://www.jakpsatweb.cz/">Jak psát web</a> pí¹e Yuhù, 
Du¹an Janovský. <a href="http://www.jakpsatweb.cz/kontakt.html">Kontakt</a>. 
<a href="http://www.jakpsatweb.cz/archiv/pristupnost.html">Prohlá¹ení o pøístupnosti</a>. Poslední aktualizace
26. dubna 2008.

</p>

<script src="mod-rewrite-priklady_soubory/my-urchin.js" type="text/javascript"></script>





<div style="position: absolute; left: 0px; top: 0px; z-index: 1000000000 ! important; visibility: hidden; opacity: 1;" id="linkalert-box"><img src="mod-rewrite-priklady_soubory/none-icon.png" id="linkalert-icon-1"></div></body></html>