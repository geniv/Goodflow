<!doctype html public "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=Windows-1250">
<title>Transakce a body návratu v SQL</title>
<link rel='stylesheet' style='text/css' href='../function.css'>
</head>

<body bgcolor="#FFFFFF" text="#000000"><table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
	<td style="background-image: url(../images/bghead.jpg);
		background-position: right;
		background-repeat: no-repeat;">
	<table width="100%" border="0" cellpadding="0" cellspacing="0"
		style="background-image:none">
	<tr>
		<td style="background-image:none" height="46"
			width="15%"><img src="../images/title-cz.gif"
			width="255" height="33"
			alt="602SQL-Úplná dokumentace"
			title="602SQL - Úplná dokumentace"
			border="0"></td>
		<td width="33%" align="right"><a href="../xml/html/top.html"><img class="floatno"
			src="../images/index.gif"
			width="15" height="16"
			alt="Index" title="Zpìt na obsah"
			border="0" vspace="2"></a> &nbsp;
			 </td>
	</tr>
	</table>
	</td>
</tr>
</table><table class="navigace" border="0" width="100%"  bgcolor="#FFFFBF"><tr> <td
width="20" align="center"><img class="floatno" src="../images/prev.gif"
width="15" height="13" alt="&lt;&shy;" title="Pøedcházející téma"
border="0"></td><td width="25%"><a
href="HE_SQL2_KURZORY.htm">Kurzory v SQL</a></td> <td width="25%"
align="right"><img class="floatno" src="../images/up.gif" width="13"
height="15" alt="Nahoru" title="O jednu úroveò výš" border="0"
align="middle"></td><td width="25%"><a href="HE_SQL2_JAZYKSQL.htm">Jazyk SQL a jeho implementace</a></td>
<td width="25%" align="right"><a
href="../xml/html/errorsexceptions.html">Chyby a výjimky</a></td><td width="20"
align="center"><img class="floatno" src="../images/next.gif" width="15"
height="13" alt="&shy;&gt;" title="Následující téma" border="0"></td>
</tr></table>




<h1><a name="he_sql2_transakce"></a>Transakce (SQL)</h1>

<p>Transakce spojují provádìní operací s databází do nedìlitelných (atomických) celkù. Operace sdružené do transakce mohou být jako celek:
<ul><li>buï <em>potvrzeny</em> (<em>commit</em>) a teprve tím se jejich efekt stane jako celek viditelný pro ostatní klienty (viz <a href="HE_SQL2_IZOLACETRANSAKCI.htm">izolace transakcí</a>), </li>
<li>anebo <em>odvolány</em> (<em>rollback</em>) a tím jejich jakýkoliv efekt na databázi zmizí.</li>
</ul>
Transakce se používají tam, kde skupina operací v databází spolu úzce souvisí a potøebujeme se vyhnout situaci, že se èást z nich provede a èást ne. Typickým pøíkladem je pøevádìní penìz z úètu na úèet: je potøeba souèasnì pøevádìnou èástku z jednoho úètu odeèíst a na druhý pøièíst.</p>

<p>Po zahájení transakce se zmìny ukládají do interního transakèního logu, který je zpoèátku v operaèní pamìti a pøi vìtších transakcích se odkládá na disk do souboru <code>transact.fil</code>. Až do commitu jsou tedy v databázi uložené hodnoty z doby pøed zahájením transakce. Jedním z dùsledkù zapnutého jištìní transakcí (viz <a href="../xml/html/ochrtrans.html">Ochrana transakcemi a jištìním transakcí</a>) je to, že veškerý transakèní obsah se ukládá na disk, aby nedošlo ke ztrátì dat pøi vypnutí serveru (transakce se dokonèí pøi dalším spuštìní).
</p>

<h2>Øízení transakcí pøi posílání pøíkazù z klienta</h2>

<p>Po pøipojení se klienta na server se každý pøíkaz (ovlivòující data) provádí jako samostatná transakce. Pokud probìhne úspìšnì, je potvrzen, pøi chybì je odvolán. Tìmto transakcím øíkáme <em>implicitní</em> (tento režim se také nazývá <em>autocommit</em>).</p>

<p>Provede-li klient SQL pøíkaz START TRANSACTION nebo zavolá-li API funkci <a href="HE_F_STARTTRANSACTION.htm"><code>Start_transaction</code></a>, otevøe tím <em>explicitní</em> transakci, která sdruží provádìní následujících pøíkazù. Tuto transakci pak klient buï potvrdí SQL pøíkazem COMMIT nebo API funkcí <a href="HE_F_COMMIT.htm"><code>Commit</code></a>, anebo odvolá SQL pøíkazem ROLLBACK nebo API funkcí <a href="HE_F_ROLLBACK.htm"><code>Roll_back</code></a>. Po potvrzení nebo odvolání transakce se zpracování pøíkazù vrací do režimu, v nìmž je každý pøíkaz provádìn v samostatné transakci, až do pøípadného otevøení další explicitní transakce.</p>

<h3>Chyba v explicitní transakci</h3>

<p>Pokud bìhem provádìní pøíkazù v explicitní transakci dojde k <a href="../xml/html/errortransaction.html">závažné chybì</a>, nastane <em>implicitní rollback</em>. V závislosti na nastavení <a href="../xml/html/sqloptions.html">pøíznaku kompatibility</a> SQLOPT_ERROR_STOPS_TRANS je buï transakce odvolána ihned anebo trvá až do explicitního ukonèení a je odvolána až pøi nìm.</p> 

<p>V prvním pøípadì je transakce chybou automaticky odvolána a zpracování pøíkazù vrací do režimu, v nìmž je každý pøíkaz provádìn v samostatné transakci. Klient proto nesmí pokraèovat v posílání zbylých pøíkazù nedokonèené pùvodní transakce, protože by se provedly v samostatných transakcích (a tudíž nebudou odvolány).</p>

<p>V druhém pøípadì klient mùže chybu ignorovat a je zaruèeno, že i zbylé pøíkazy budou odvolány. SQL pøíkaz COMMIT nebo API funkce <code>Commit</code> provedené po chybì odvolají a ukonèí chybnou transakci.</p>

<p>Implicitní rollback zpùsobí také volání funkce klientského API <code>cd_Break_user</code> a <code>cd_disconnect</code>.</p>

<h3>Vynucené ukonèení explicitní transakce</h3>

<p>Existují nìkteré speciální akce, které vždy provedou potvrzení explicitní transakce (<em>implicitní commit</em>) bez ohledu na pùvodní èlenìní transakce. Jedná se o takové akce, které by nešlo pøípadnì odvolat. Patøí mezi nì volání funkcí klientského API <code>Delete_all_records</code>, <code>Free_deleted</code>, <code>Backup_database_file</code>, <code>Compact_table</code>, <code>Compact_database</code>, <code>Database_integrity</code>, <code>Move_data</code>, <code>Login</code>, <code>Logout</code> a <code>Set_property_value</code> pro vlastnost <code>SERVER_KEY</code>. Commit se provede také pøed nebo po provedení SQL pøíkazù DROP TABLE, ALTER TABLE, CREATE INDEX, DROP INDEX, DROP SCHEMA, ALTER DOMAIN, CREATE SEQUENCE, ALTER SEQUENCE, CREATE FULLTEXT, DROP FULLTEXT, ALTER FULLTEXT, RENAME. Commit se provádí také pøi volání funkcí pro pøíjem pošty, které pracují se systémovými tabulkami (<code>MailBoxLoad</code>, <code>MailBoxGetFilInfo</code>, <code>MailBoxGetMsgEx</code>, <code>MailBoxGetMsg</code>, <code>MailBoxSaveFileDBs</code>, <code>MailBoxSaveFileDBr</code>).</p>

<h3>Transakce ve vývojovém prostøedí</h3>

<p>Interaktivní práce s vývojovým klientem zahrnuje v mnoha akcích ukonèování transakcí napø. pøi otevøení aplikace, používání návrháøù apod. Pøi bìžné práci také dochází ke (skrytým) chybám, které odvolají pøípadnou transakci. I když je možné pomocí SQL konzole otevøít explicitní transakci pro vývojového klienta, nelze to doporuèit, protože uživatel nemá kontrolu nad jejím ukonèením.</p>


<h2>Øízení transakcí v procedurách provádìných na serveru</h2>

<p>Spustí-li klient <a href="HE_SQL2_STOREDPROCEDURE.htm">proceduru</a> na serveru, probíhá celá operace v jedné (implicitní) transakci. To platí i o akcích vyvolaných v dùsledku provádìní pøíkazù, napøíklad o provádìní triggerù nebo akcí aktivní referenèní integrity.</p>

<p>Pokud má být tato posloupnost akcí rozèlenìna do více (implicitních) transakcí, je tøeba do ní zaøadit pøíkaz COMMIT. Tím se potvrdí pøedchozí transakce a automaticky zahájí nová. </p>

<p><em>Explicitními</em> transakcemi lze pøesnìji øídit atomicitu akcí. Explicitní transakce mùže trvat pøes hranici procedury. Explicitní transakce nelze používat v <a href="HE_SQL2_TRIGGERY.htm">triggerech</a>.</p>

<h2>Další vlastnosti transakcí</h2>

<p>Rollback neumožòuje odvolat pøiøazení hodnoty lokální promìnné ani efekt provedených externích rutin (napøíklad odeslání dopisu, zápis do logu).</p>

<p>Transakce nelze vnoøovat do sebe. Vnoøení transakcí vyvolá chybu.</p>

<p>Pro úèely ladìní mùže být výhodné <a href="../xml/html/tracelog.html">trasovat</a> vyvolání implicitních rollbackù z dùvodu chyby (situace <code>TRACE_IMPL_ROLLBACK</code>).</p>

<p>Použití transakcí také úzce souvisí se <a href="../xml/html/ochrtrans.html">zajištìním databáze</a> proti porušení integrity.</p>

<p>Informace o transakcích a jejich ovlivnìní chybami poskytují klientské funkce <a href="../xml/html/f_Transaction_open.html"><code>Transaction_open</code></a> a <a href="../xml/html/f_Rolled_back.html"><code>Rolled_back</code></a>. Stav transakce libovolného vlákna lze zjistit  pomocí systémového dotazu <a href="../xml/html/_iv_logged_users.html"><code>_iv_logged_users</code></a>, sloupec <code>Transaction_open</code>. </p>

<h2>Body návratu</h2>
<p>Kromì transakcí existuje ještì jeden mechanismus dovolující odvolat skupinu provedených pøíkazù a vrátit se do stavu pøed jejich provedením. Tímto mechanismem jsou body návratu (savepoints).</p>

<p>Pomocí pøíkazu SAVEPOINT lze uvnitø transakce vytvoøit bod návratu. Po provedení dalších pøíkazù lze se pak pøíkazem ROLLBACK TO SAVEPOINT vrátit k tomu stavu databáze, který byl v okamžiku provedení pøíkazu SAVEPOINT (a neukonèit transakci). </p>
<br>
<p><b>Odchylky od Intermediate level smìrem k Full level nebo k SQL 3</b>

<ul>
	<li>Transakèní pøíkazy jsou implementovány dle úrovnì SQL 3.</li>
</ul>



<p class="subs">Seznam subsekcí:
<ul class="subs">

<li><a href="HE_SQL2_IZOLACETRANSAKCI.htm">Izolace transakcí</a>

<li><a href="../xml/html/lockizol.html">Problémy pøi kombinaci explicitního zamykání záznamù a izolace transakcí</a>

<li><a href="HE_SQL2_STARTTRANSACTION.htm">Pøíkaz START TRANSACTION</a>

<li><a href="HE_SQL2_COMMIT.htm">Pøíkaz COMMIT</a>

<li><a href="HE_SQL2_ROLLBACK.htm">Pøíkaz ROLLBACK</a>

<li><a href="HE_SQL2_SETTRANSACTION.htm">Pøíkaz SET TRANSACTION</a>

<li><a href="HE_SQL2_SAVEPOINT.htm">Pøíkaz SAVEPOINT</a>

<li><a href="HE_SQL2_RELEASESAVEPOINT.htm">Pøíkaz RELEASE SAVEPOINT</a>

</ul>
<table class="navigace" border="0" width="100%"  bgcolor="#FFFFBF"><tr> <td
width="20" align="center"><img class="floatno" src="../images/prev.gif"
width="15" height="13" alt="&lt;&shy;" title="Pøedcházející téma"
border="0"></td><td width="25%"><a
href="HE_SQL2_KURZORY.htm">Kurzory v SQL</a></td> <td width="25%"
align="right"><img class="floatno" src="../images/up.gif" width="13"
height="15" alt="Nahoru" title="O jednu úroveò výš" border="0"
align="middle"></td><td width="25%"><a href="HE_SQL2_JAZYKSQL.htm">Jazyk SQL a jeho implementace</a></td>
<td width="25%" align="right"><a
href="../xml/html/errorsexceptions.html">Chyby a výjimky</a></td><td width="20"
align="center"><img class="floatno" src="../images/next.gif" width="15"
height="13" alt="&shy;&gt;" title="Následující téma" border="0"></td>
</tr></table>
</body>
</html>
