<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1250"></head><body>


<p>Tento èlánek bude uiteènı pøedevším tìm, kdo mají na internetu své
fotogalerie, nebo se chystají nìco podobného naprogramovat. Ostatnì
návod na jednu variantu obrázkové galerie máte pøímo zde na Webtipu. O
co jde? Kadého, kdo si bude chtít umístit na internet své obrázky,
potká situace, kdy si bude muset vytvoøit z onìch obrázkù náhledy
(zmenšeniny). O tom, e to je pracná záleitost se tu nemá cenu
rozepisovat. Proto také vznikla øada programù, které mají tvorbu
náhledù usnadnit. Jako jeden pøíklad za všechny mohu uvést napøíklad
program ACDSee, kterı je mimo jiné vıbornı prohlíeè obrázkù. Nìkdo by
teï mohl pøedhodit otázku: "Je moné obrázky zmenšovat pomocí PHP?"
Samozøejmì. A o tom dnešní èlánek bude. Jeden mùj kolega tu pøed èasem
podobnou situaci se zmenšováním obrázkù probíral. Jeho skript fungoval
tak, e z obrázkù uloenıch v adresáøi udìlal zmenšeniny, které potom
uloil do jiného adresáøe. Struèné a jednoduché. Já jsem tento proces
obohatil ještì o pár malièkostí, které doufám pøijdou nìkterım vhod.
Pøed samotnım zmenšováním se vám otevøe formuláø, kde si budete moci
navolit nìkteré podmínky, jako napøíklad vytvoøení progresivních
(prokládanıch) náhledù, zobrazení vıslednıch obrázkù po ukonèení bìhu
skriptu nebo si budete moci nastavit i poadovanou kvalitu obrázkù.
Princip pak zùstává stejnı.</p>
<p>Zaènu tedy skriptem. Celı php kód jsem rozdìlil na dvì èásti - èást,
která se provede po odeslání formuláøe a má za úèel zjistit hlavní
promìnné, je pak pøedá funkci, no a samotnou funkci, která obrázky
zmenšuje. Toto je èást první:</p>
<table valign="top" style="border: 1px solid black;" align="center" cellpadding="2" cellspacing="0" height="1" width="100%"><tbody><tr bgcolor="#dddddd"><td>
if ($resize == "OK"):<br>
	set_time_limit(60);<br>
DL("php_gd.dll");						<span style="color: blue;">//naètení DLL knihovny pro práci s obrázky</span><br>
	include "conf.php";<br>
	$dp = OpenDir($cur_dir);					<span style="color: blue;">//nastaveni adresare - vraci ukazatel $dp</span><br>
	$i = 0;<br>
	$soubor[$i] = ReadDir($dp);<br>
	while ($soubor[$i] == true):					<span style="color: blue;">//vypis vsech souboru v nastavenem adresari</span><br>
		$pis = ReadDir($dp);<br>
		$i++;<br>
		$soubor[$i] = $pis;					<span style="color: blue;">//$soubor[2] je prvnim souborem v adresari</span><br>
	endwhile;					<span style="color: blue;">//zachována promenna $i, ktera je pocet souboru +2</span><br>
	CloseDir($dp);<br>
	<br>
	for ($y=2; $y&lt;=$i-1; $y++):<br>
		$size[$y] = GetImageSize($cur_dir."/".$soubor[$y]);<br>
		$width = $size[$y][0];<br>
		$height = $size[$y][1];<br>
<br>
		if ($new_width &lt;= $new_height):<br>
			$widthto = $new_width;<br>
			$ratio = $width/$widthto;<br>
			$heightto = Ceil($height/$ratio);<br>
		else:<br>
			$heightto = $new_height;<br>
			$ratio2 = $height/$heightto;<br>
			$widthto = Ceil($width/$ratio2);<br>
		endif;<br>
		$outfile = Str_Replace(" ", "_", $soubor[$y]);<br>
		$outfile = strtr($outfile, "áèïìéíòøšùúıüäëö", "acdeeinrstuuyzuaeo");<br>
		$outfile = StrToLower($outfile);<br>
		resize($soubor[$y], "small_".$outfile, $widthto, $heightto, $quality, $show, $interlace);<br>
	endfor;<br>
endif;
</td></tr><tr></tr></tbody></table>
<p>Funguje to tak, e po odeslání formuláøe se naète potøebná DLL knihovna a nezbytné promìnné ze souboru <b>conf.php</b>
- jsou vlastnì jen 2 - urèení adresáøe s originálními obrázky a
adresáøe, kam se uloí náhledy. Následuje cyklus, ve kterém se do pole <b>$soubor</b>
uloí názvy souborù obrázkù. V dalším cyklu se zjistí originální
velikosti obrázkù v pixelech a porovnají se uivatelem zadané hodnoty,
podle kterıch se obrázky zmenší buï na vıšku, nebo na šíøku. Ještì
nahradíme nìkteré nebezpeèné znaky v názvech souborù a mùeme
pøistoupit k funkci, která obrázky zmenší. Tady je:</p>
<table valign="top" style="border: 1px solid black;" align="center" cellpadding="2" cellspacing="0" height="1" width="100%"><tbody><tr bgcolor="#dddddd"><td>
function resize($cur_file, $copy_file, $widthto, $heightto, $quality, $show, $interlace)<br>
{<br>
include "conf.php";<br>
$ssize=GetImageSize($cur_dir."/".$cur_file);<br>
$end = Explode(".", $cur_file);<br>
<span style="color: red;">if ((strtolower($end[1]) == "jpg") || (strtolower($end[1]) == "jpeg")):</span><br>
&nbsp;	$fp = imagecreatefromjpeg ($cur_dir."/".$cur_file);<br>
&nbsp;	$fx = imagecreate ($widthto,$heightto-1);<br>
&nbsp;	imagecopyresized ($fx,$fp,0,0,0,0,$widthto,$heightto,$ssize[0],$ssize[1]);<br>
<span style="color: blue;">&nbsp;	if ($interlace == "on"): ImageInterlace($fx , 1); endif;</span><br>
&nbsp;	imageJPEG ($fx, $copy_file, $quality);<br>
&nbsp;	Copy($copy_file, $copy_dir."/".$copy_file);<br>
&nbsp;	unlink($copy_file);<br>
&nbsp;	ImageDestroy($fp);<br>
&nbsp;	ImageDestroy($fx);<br>
&nbsp;	$kilo = Round(FileSize($copy_dir."/".$copy_file)/1024, 2);<br>
&nbsp; echo "&lt;div align=\"center\"&gt;&lt;b&gt;".$cur_file." =&gt;
".$copy_file."&lt;/b&gt;&lt;br&gt;&lt;b&gt;".$widthto." X ".$heightto."
px ; ".$kilo." Kb&lt;/b&gt;&lt;br&gt;&lt;/div&gt;";<br>
<span style="color: blue;">&nbsp; if ($show == "on"): echo "&lt;div
align=\"center\"&gt;&lt;img
src=\"resized/".$copy_file."\"&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;";
endif;</span><br>
<span style="color: red;">elseif (strtolower($end[1]) == "png"):	</span><br>
&nbsp;	If ( @$fp = imagecreatefrompng ($cur_dir."/".$cur_file) ):<br>
&nbsp;		$fx = imagecreate ($widthto,$heightto-1);<br>
&nbsp;		imagecopyresized ($fx,$fp,0,0,0,0,$widthto,$heightto,$ssize[0],$ssize[1]);<br>
&nbsp;		if ($interlace == "on"): ImageInterlace($fx , 1); endif;<br>
&nbsp;		imagePNG ($fx, $copy_file, $quality);<br>
&nbsp;		Copy($copy_file, $copy_dir."/".$copy_file);<br>
&nbsp;		unlink($copy_file);<br>
&nbsp;		ImageDestroy($fp);<br>
&nbsp;		ImageDestroy($fx);<br>
&nbsp;		$kilo = Round(FileSize($copy_dir."/".$copy_file)/1024, 2);<br>
&nbsp; echo "&lt;div align=\"center\"&gt;&lt;b&gt;".$cur_file." =&gt;
".$copy_file."&lt;/b&gt;&lt;br&gt;&lt;b&gt;".$widthto." X ".$heightto."
px ; ".$kilo." Kb&lt;/b&gt;&lt;br&gt;&lt;/div&gt;";<br>
&nbsp; if ($show == "on"): echo "&lt;div align=\"center\"&gt;&lt;img
src=\"resized/".$copy_file."\"&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;";
endif;<br>
&nbsp;	else:<br>
&nbsp; echo "&lt;div align=\"center\" style=\"color: red;\"&gt;Your
version of GD library doesn't support PNG images.&lt;br&gt;Image
&lt;b&gt;".$cur_file."&lt;/b&gt; wasn't resized.
Sorry.&lt;br&gt;&lt;br&gt;&lt;/div&gt;";<br>
&nbsp;	endif;<br>
endif;<br>
}
</td></tr><tr></tr></tbody></table>
<p>Jak vidíte, funkce je rozdìlená na 2 èásti - jedna pro obrázky ve
formátu PNG a druhá pro JPG. Podpora GIFù byla v PHP odebrána, tak
proto tu o gifech nic není. Typ obrázku zjistíme podle pøípony, kde se
pomocí funkce Explode oddìlí název od pøípony (separátor bude logicky
teèka). Dále je u skript vcelku jednoduchı. Pomocí dvou image-funkcí
(imagecreatefromjpeg() a imagecopyresized()) danı obrázek zmenšíme a
dále pak pokud je zvoleno vytvoøení progresívních obrázkù, vyuijeme
funkci ImageInterlace() a obrázky pøevedeme. Kvalitu obrázku nastavíme
ve funkci imageJPEG() nebo imagePNG(). Následuje u jen zkopírování
obrázkù do poadovaného adresáøe, uvolnìní pamìti pomocí ImageDestroy()
a vypsání informací na obrazovku. Pokud si uivatel zvolí zobrazení
zmenšenıch obrázkù, tak je vyhodíme na obrazovku spolu s informacemi.
Tímto je jeden cyklus hotov a mùe se pøistoupit ke zmenšení pøípadnıch
dalších obrázkù.</p>
<p>Myslím, e celı skript je vcelku pøehlednì sestavenı, tak by jeho
pochopení a pouívání nemìlo dìlat problémy. Komplikace by mohly nastat
v pøípadì, kdy byste nemìli správnou knihovnu pro práci s PNG a JPG
obrázky. To vám nezbude nic jiného, ne si pøíslušné soubory stáhnout z
internetu. V tomto èlánku je to všechno. Máte-li zájem o zdrojáky - <a href="http://www.webtip.cz/images/inteli_ir.zip">JSOU ZDE</a>. Pøíštì chystám další specialitu - zápis copyrightù na originální obrázky. ;) Víc neprozradím...nechte se pøekvapit.</p>

</body></html>